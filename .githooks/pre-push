#!/bin/bash
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“„ VALIDACIÃ“N DE DOCUMENTACIÃ“N PHPDOC
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ” Ejecutando validaciÃ³n PHPDoc con PHPCS..."

# Obtener archivos PHP modificados
FILES=$(git diff --cached --name-only HEAD | grep -E '\.php$')

# Si no hay archivos PHP modificados, no hacemos nada
if [ -z "$FILES" ]; then
    echo "âœ… No hay archivos PHP modificados para validar."
    exit 0
fi

# Flag de errores
ERROR=0

# FunciÃ³n para extraer el rango de lÃ­neas de una funciÃ³n/clase modificada
get_modified_declarations() {
    local file=$1
    # Obtener las lÃ­neas modificadas
    local modified_lines=$(git diff --cached -U0 "$file" | grep "^+" | grep -v "^+++" | cut -c2-)

    # Obtener el contenido actual del archivo
    local content=$(cat "$file")

    # Crear un archivo temporal para las declaraciones modificadas
    local temp_file=$(mktemp)

    # Archivo temporal para guardar informaciÃ³n de contexto
    local context_file=$(mktemp)

    # Por cada lÃ­nea modificada, extraer la declaraciÃ³n completa
    while IFS= read -r line; do
        # Encontrar el nÃºmero de lÃ­nea donde aparece la modificaciÃ³n
        line_number=$(echo "$content" | grep -n "$line" | cut -d: -f1)
        if [ ! -z "$line_number" ]; then
            # Buscar hacia arriba hasta encontrar la declaraciÃ³n
            declaration_line=$(echo "$content" | head -n "$line_number" | tac | grep -n -m 1 "^[[:space:]]*(public\|private\|protected\|function\|class)" | cut -d: -f1)
            start_line=$((line_number - declaration_line + 1))

            # Buscar hacia abajo hasta encontrar el cierre
            end_line=$((line_number + $(echo "$content" | tail -n+"$line_number" | grep -n -m 1 "^[[:space:]]*}" | cut -d: -f1)))

            # Extraer la declaraciÃ³n
            echo "# Archivo: $file (lÃ­neas $start_line-$end_line)" >> "$context_file"
            sed -n "${start_line},${end_line}p" "$file" >> "$temp_file"
            echo "" >> "$temp_file"
        fi
    done <<< "$modified_lines"

    # Devolver ambos archivos temporales
    echo "$temp_file:$context_file"
}

# Verificar cada archivo PHP modificado
for FILE in $FILES; do
    if [ -f "$FILE" ]; then
        echo "ğŸ“‚ Validando $FILE ..."
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

        # Obtener las declaraciones modificadas y su contexto
        TEMP_FILES=$(get_modified_declarations "$FILE")
        TEMP_FILE=$(echo "$TEMP_FILES" | cut -d: -f1)
        CONTEXT_FILE=$(echo "$TEMP_FILES" | cut -d: -f2)

        if [ -s "$TEMP_FILE" ]; then
            # Mostrar quÃ© declaraciones especÃ­ficas estÃ¡n siendo validadas
            echo "ğŸ” Validando las siguientes declaraciones modificadas:"
            cat "$CONTEXT_FILE"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

            # Validar solo las declaraciones modificadas
            PHPCS_OUTPUT=$(vendor/bin/phpcs --standard=phpcs.xml "$TEMP_FILE" 2>&1)
            PHPCS_STATUS=$?

            # Mostrar el resultado de la validaciÃ³n
            if [ $PHPCS_STATUS -ne 0 ]; then
                echo "âŒ Se encontraron problemas en la documentaciÃ³n:"
                echo "$PHPCS_OUTPUT"
                ERROR=1
            else
                echo "âœ… La documentaciÃ³n cumple con los estÃ¡ndares."
            fi
        else
            echo "â„¹ï¸ No se encontraron declaraciones modificadas que requieran validaciÃ³n."
        fi

        # Limpiar archivos temporales
        rm -f "$TEMP_FILE" "$CONTEXT_FILE"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    else
        echo "âš ï¸ Archivo omitido (no existe): $FILE"
    fi
done

# Si hay errores, cancelar el push
if [ $ERROR -ne 0 ]; then
    echo "âŒ Se encontraron errores en la documentaciÃ³n PHPDoc. Corrige antes de hacer push."
    exit 1
fi

echo "âœ… ValidaciÃ³n exitosa. Continuando con el push."
exit 0