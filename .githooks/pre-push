#!/bin/bash

# --------------------------------------------------------------------
# Validaci√≥n y correcci√≥n autom√°tica de documentaci√≥n PHPDoc.
# Este hook pre-push:
# 1. Detecta archivos PHP modificados.
# 2. Corrige autom√°ticamente la documentaci√≥n PHPDoc.
# 3. Ejecuta PHPCS para validar estilo y formato.
# 4. Si hay errores tras la correcci√≥n, bloquea el push.
# --------------------------------------------------------------------

echo "üîß Iniciando proceso de correcci√≥n y validaci√≥n PHPDoc..."

FILES=$(git diff --cached --name-only origin/$(git rev-parse --abbrev-ref HEAD) | grep -E '\.php$')

if [ -z "$FILES" ]; then
  echo "‚úÖ No hay archivos PHP modificados para validar."
  exit 0
fi

ERROR=0
FILES_CORREGIDOS=()
FILES_CON_ERRORES=()
FILES_VALIDOS=()

for FILE in $FILES; do
  if [ -f "$FILE" ]; then
    echo ""
    echo "üìÇ Procesando: $FILE"

    # Ejecutar el script de correcci√≥n de PHPDoc
    CORRECCION_OUTPUT=$(php scripts/doc-fixer.php "$FILE")
    echo "üõ†Ô∏è Resultado de correcci√≥n:"
    echo "$CORRECCION_OUTPUT"

    # Ejecutar PHPCBF para corregir errores simples autom√°ticamente
    php vendor/bin/phpcbf "$FILE"

    # Ejecutar PHPCS
    PHPCS_OUTPUT=$(php vendor/bin/phpcs "$FILE")
    PHPCS_STATUS=$?

    if [ $PHPCS_STATUS -ne 0 ]; then
      echo "‚ùå PHPCS detect√≥ errores en $FILE"
      echo "$PHPCS_OUTPUT"
      FILES_CON_ERRORES+=("$FILE")
      ERROR=1
    else
      echo "‚úÖ $FILE validado correctamente con PHPCS"
      # Si la correcci√≥n hizo cambios, agregamos a lista de corregidos
      if echo "$CORRECCION_OUTPUT" | grep -q "corregida" || echo "$CORRECCION_OUTPUT" | grep -q "agregada"; then
        FILES_CORREGIDOS+=("$FILE")
      else
        FILES_VALIDOS+=("$FILE")
      fi
    fi
  else
    echo "‚ö†Ô∏è Archivo omitido (no existe): $FILE"
  fi
done

# üßæ Log resumen
echo ""
echo "üìã Resumen de validaci√≥n:"
if [ ${#FILES_CORREGIDOS[@]} -gt 0 ]; then
  echo "üõ†Ô∏è Archivos con correcciones aplicadas:"
  for f in "${FILES_CORREGIDOS[@]}"; do
    echo "   - $f"
  done
fi

if [ ${#FILES_VALIDOS[@]} -gt 0 ]; then
  echo "‚úÖ Archivos ya v√°lidos (sin necesidad de correcci√≥n):"
  for f in "${FILES_VALIDOS[@]}"; do
    echo "   - $f"
  done
fi

if [ ${#FILES_CON_ERRORES[@]} -gt 0 ]; then
  echo "‚ùå Archivos con errores que no pudieron ser corregidos completamente:"
  for f in "${FILES_CON_ERRORES[@]}"; do
    echo "   - $f"
  done
fi

# Resultado final
echo ""
if [ $ERROR -ne 0 ]; then
  echo "üö´ Push cancelado. Se detectaron errores que deben corregirse manualmente."
  exit 1
else
  echo "üéâ Todo validado correctamente. Continuando con el push."
  exit 0
fi
