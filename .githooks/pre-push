#!/bin/bash
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“„ VALIDACIÃ“N DE DOCUMENTACIÃ“N PHPDOC
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ” Iniciando validaciÃ³n PHPDoc con PHPCS..."
echo "ğŸ“… Fecha: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
echo "ğŸ‘¤ Usuario: $USER"

# Obtener el hash del Ãºltimo commit local y remoto
local_commit=$(git rev-parse HEAD)
remote_commit=$(git rev-parse @{u} 2>/dev/null || git hash-object -t tree /dev/null)

# Obtener archivos PHP modificados
FILES=$(git diff --name-only $remote_commit $local_commit | grep -E '\.php$')

# Si no hay archivos PHP modificados, no hacemos nada
if [ -z "$FILES" ]; then
    echo "âœ… No hay archivos PHP modificados para validar."
    exit 0
fi

# Flag de errores
ERROR=0

# FunciÃ³n para validar un bloque de cÃ³digo
validate_code_block() {
    local temp_file=$1
    local line_number=$2
    local file_name=$3

    # Ejecutar phpcs y capturar tanto la salida como el cÃ³digo de retorno
    PHPCS_OUTPUT=$(vendor/bin/phpcs --standard=phpcs.xml "$temp_file" 2>&1)
    PHPCS_STATUS=$?

    echo "Validando bloque en $file_name:$line_number"
    echo "$PHPCS_OUTPUT"

    if [ $PHPCS_STATUS -ne 0 ]; then
        echo "âŒ Error de validaciÃ³n en $file_name:$line_number"
        echo "$PHPCS_OUTPUT"
        return 1
    fi
    return 0
}

# Verificar cada archivo PHP modificado
for FILE in $FILES; do
    if git show $local_commit:"$FILE" > /dev/null 2>&1; then
        echo "ğŸ“‚ Validando $FILE ..."
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        # Crear archivo temporal para el cÃ³digo modificado
        TEMP_FILE=$(mktemp)
        echo "<?php" > "$TEMP_FILE"

        # Obtener el contenido actual del archivo
        CONTENT=$(git show $local_commit:"$FILE")

        # Obtener los hunks modificados
        git diff -U0 $remote_commit $local_commit -- "$FILE" | while read -r line; do
            if [[ $line =~ ^@@ ]]; then
                # Extraer nÃºmeros de lÃ­nea del hunk
                if [[ $line =~ \+([0-9]+) ]]; then
                    start_line="${BASH_REMATCH[1]}"
                    
                    # Buscar inicio de la funciÃ³n/mÃ©todo
                    func_start=$start_line
                    while [ $func_start -gt 1 ]; do
                        prev_line=$(echo "$CONTENT" | sed "${func_start}q;d")
                        if [[ $prev_line =~ ^\s*(/\*\*|class|function) ]]; then
                            break
                        fi
                        func_start=$((func_start - 1))
                    done

                    # Buscar final de la funciÃ³n/mÃ©todo
                    func_end=$start_line
                    while true; do
                        next_line=$(echo "$CONTENT" | sed "${func_end}q;d")
                        if [[ $next_line =~ ^\s*} ]] || [ -z "$next_line" ]; then
                            break
                        fi
                        func_end=$((func_end + 1))
                    done

                    # Extraer el bloque completo
                    echo "$CONTENT" | sed -n "${func_start},${func_end}p" > "$TEMP_FILE"

                    # Validar el bloque
                    if ! validate_code_block "$TEMP_FILE" "$start_line" "$FILE"; then
                        ERROR=1
                        echo "âŒ Error encontrado en $FILE cerca de la lÃ­nea $start_line"
                        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                        cat "$TEMP_FILE"
                        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                    fi
                fi
            fi
        done

        rm -f "$TEMP_FILE"
    else
        echo "âš ï¸ Archivo omitido (no existe): $FILE"
    fi
done

if [ $ERROR -ne 0 ]; then
    echo "âŒ Se encontraron errores en la documentaciÃ³n PHPDoc. Por favor, corrige los problemas antes de hacer push."
    exit 1
fi

echo "âœ… ValidaciÃ³n exitosa. Continuando con el push."
exit 0