#!/bin/bash
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“„ VALIDACIÃ“N DE DOCUMENTACIÃ“N PHPDOC
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ” Ejecutando validaciÃ³n PHPDoc con PHPCS (solo lÃ­neas modificadas)..."

# Obtiene el nombre de la rama actual
branch_name=$(git rev-parse --abbrev-ref HEAD)

# Obtener archivos PHP modificados (comparando contra el Ãºltimo commit en remoto)
FILES=$(git diff --cached --name-only origin/"$branch_name" | grep -E '\.php$')

# Si no hay archivos PHP modificados, no hacemos nada
if [ -z "$FILES" ]; then
  echo "âœ… No hay archivos PHP modificados para validar."
  exit 0
fi

# Flag de errores
ERROR=0

# Verificar cada archivo PHP modificado que realmente exista
for FILE in $FILES; do
  if [ -f "$FILE" ]; then
    echo "ğŸ“‚ Validando lÃ­neas modificadas en $FILE ..."

    # Obtener solo las lÃ­neas modificadas del archivo actual
    DIFF_RANGE=$(git diff --cached -U0 origin/"$branch_name" -- "$FILE" | \
                grep -E "^@@" | \
                awk '{split($3,a,","); if(a[2]=="") a[2]=1; print a[1]+1"-"a[1]+a[2]}' | \
                tr '\n' ',')

    # Eliminar la Ãºltima coma
    DIFF_RANGE=${DIFF_RANGE%,}

    if [ -n "$DIFF_RANGE" ]; then
      # Ejecutar PHPCS solo en las lÃ­neas modificadas, manteniendo el estÃ¡ndar definido
      vendor/bin/phpcs --standard=phpcs.xml --lines="$DIFF_RANGE" "$FILE"
      if [ $? -ne 0 ]; then
        ERROR=1
      fi
    else
      echo "â„¹ï¸ No se detectaron cambios en lÃ­neas de cÃ³digo para $FILE"
    fi
  else
    echo "âš ï¸ Archivo omitido (no existe): $FILE"
  fi
done

# Si hay errores, cancelar el push
if [ $ERROR -ne 0 ]; then
  echo "âŒ Se encontraron errores en la documentaciÃ³n PHPDoc. Corrige antes de hacer push."
  exit 1
fi

echo "âœ… ValidaciÃ³n exitosa. Continuando con el push."
exit 0