#!/bin/bash

# --------------------------------------------------------------------
# ValidaciÃ³n y correcciÃ³n automÃ¡tica de documentaciÃ³n PHPDoc.
# Este hook pre-push:
# 1. Detecta archivos PHP modificados.
# 2. Corrige automÃ¡ticamente la documentaciÃ³n PHPDoc.
# 3. Organiza la documentaciÃ³n segÃºn la plantilla establecida.
# 4. Ejecuta PHPCS para validar estilo y formato.
# 5. Si hay errores tras la correcciÃ³n, bloquea el push.
# --------------------------------------------------------------------

echo "ğŸ”§ Iniciando proceso de correcciÃ³n, organizaciÃ³n y validaciÃ³n PHPDoc..."

# Detectar archivos PHP modificados en staging
FILES=$(git diff --cached --name-only origin/$(git rev-parse --abbrev-ref HEAD) | grep -E '\.php$')

if [ -z "$FILES" ]; then
  echo "âœ… No hay archivos PHP modificados para validar."
  exit 0
fi

ERROR=0
FILES_CORREGIDOS=()
FILES_CON_ERRORES=()
FILES_VALIDOS=()

for FILE in $FILES; do
  if [ -f "$FILE" ]; then
    echo ""
    echo "ğŸ“‚ Procesando archivo: $FILE"

    # Ejecutar el script de correcciÃ³n y organizaciÃ³n PHPDoc
    echo "ğŸ“„ Ejecutando scripts de documentaciÃ³n automÃ¡tica en: $FILE"
    CORRECCION_OUTPUT=$(php scripts/run-doc-fixer.php "$FILE")
    echo "ğŸ› ï¸ Resultado de correcciÃ³n automÃ¡tica:"
    echo "$CORRECCION_OUTPUT"

    # Ejecutar PHPCBF para correcciÃ³n automÃ¡tica de estilo
    echo "ğŸ” Ejecutando PHPCBF..."
    PHPCBF_OUTPUT=$(php vendor/bin/phpcbf "$FILE")
    echo "$PHPCBF_OUTPUT"

    # Validar con PHPCS
    echo "âœ… Ejecutando PHPCS..."
    PHPCS_OUTPUT=$(php vendor/bin/phpcs "$FILE")
    PHPCS_STATUS=$?

    if [ $PHPCS_STATUS -ne 0 ]; then
      echo "âŒ PHPCS detectÃ³ errores en: $FILE"
      echo "$PHPCS_OUTPUT"
      FILES_CON_ERRORES+=("$FILE")
      ERROR=1
    else
      echo "âœ… PHPCS validÃ³ correctamente el archivo: $FILE"

      # Detectar si se aplicaron correcciones o adiciones de documentaciÃ³n
      if echo "$CORRECCION_OUTPUT" | grep -qE "corregida|agregada|organizada"; then
        echo "ğŸ“Œ DocumentaciÃ³n modificada o reestructurada en: $FILE"
        FILES_CORREGIDOS+=("$FILE")
      else
        echo "ğŸ“˜ Archivo vÃ¡lido y sin necesidad de cambios: $FILE"
        FILES_VALIDOS+=("$FILE")
      fi
    fi
  else
    echo "âš ï¸ Archivo omitido (no existe): $FILE"
  fi
done

# ğŸ§¾ Log resumen detallado
echo ""
echo "ğŸ“‹ RESUMEN FINAL DEL PROCESO"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

if [ ${#FILES_CORREGIDOS[@]} -gt 0 ]; then
  echo "ğŸ› ï¸ Archivos con documentaciÃ³n corregida o organizada:"
  for f in "${FILES_CORREGIDOS[@]}"; do
    echo "   - $f"
  done
fi

if [ ${#FILES_VALIDOS[@]} -gt 0 ]; then
  echo "âœ… Archivos vÃ¡lidos sin necesidad de modificaciÃ³n:"
  for f in "${FILES_VALIDOS[@]}"; do
    echo "   - $f"
  done
fi

if [ ${#FILES_CON_ERRORES[@]} -gt 0 ]; then
  echo "âŒ Archivos con errores pendientes:"
  for f in "${FILES_CON_ERRORES[@]}"; do
    echo "   - $f"
  done
fi

# Resultado final
echo ""
if [ $ERROR -ne 0 ]; then
  echo "ğŸš« Push cancelado. Debes corregir los errores antes de continuar."
  exit 1
else
  echo "ğŸ‰ Todo validado correctamente. Push permitido."
  exit 0
fi
