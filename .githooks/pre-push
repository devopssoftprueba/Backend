#!/bin/bash
set -e

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# üìÑ VALIDACI√ìN DE DOCUMENTACI√ìN PHPDOC
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
echo "üîç Iniciando validaci√≥n PHPDoc con PHPCS..."
echo "üìÖ Fecha: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
echo "üë§ Usuario: $(git config user.name)"

# Funci√≥n para salir con error
exit_with_error() {
    echo "‚ùå $1"
    exit 1
}

# Obtener commits para comparaci√≥n
local_commit=$(git rev-parse HEAD) || exit_with_error "No se pudo obtener el commit local"
remote_commit=$(git rev-parse @{u} 2>/dev/null || git hash-object -t tree /dev/null)

# Directorio temporal con cleanup autom√°tico
TEMP_DIR=$(mktemp -d) || exit_with_error "No se pudo crear directorio temporal"
trap 'rm -rf "$TEMP_DIR"' EXIT

# Funci√≥n para encontrar los l√≠mites exactos de una funci√≥n
get_function_bounds() {
    local file=$1
    local target_line=$2
    local content="$3"
    
    # Buscar hacia arriba hasta encontrar el inicio del docblock o la funci√≥n
    local start=$target_line
    while [ $start -gt 1 ]; do
        local line=$(echo "$content" | sed "${start}q;d")
        if [[ $line =~ ^[[:space:]]*(public|private|protected|function)[[:space:]]+ ]]; then
            break
        fi
        start=$((start - 1))
    done
    
    # Buscar hacia abajo hasta encontrar el final de la funci√≥n
    local end=$target_line
    local found_bracket=false
    local bracket_count=0
    
    while IFS= read -r line; do
        if [[ $line =~ \{ ]]; then
            found_bracket=true
            ((bracket_count++))
        fi
        if [[ $line =~ \} ]]; then
            ((bracket_count--))
        fi
        if [ "$found_bracket" = true ] && [ $bracket_count -eq 0 ]; then
            break
        fi
        ((end++))
    done < <(echo "$content" | tail -n +$target_line)
    
    echo "$start $end"
}

# Funci√≥n para validar una funci√≥n espec√≠fica
validate_function() {
    local file=$1
    local start_line=$2
    local end_line=$3
    local temp_file="$TEMP_DIR/temp_func.php"
    local original_line_offset=$((start_line - 2))  # -2 por el <?php y el espacio
    
    # Crear archivo PHP v√°lido para testing
    echo "<?php" > "$temp_file"
    echo "" >> "$temp_file"  # L√≠nea en blanco para mantener n√∫meros de l√≠nea consistentes
    git show "$local_commit:$file" | sed -n "${start_line},${end_line}p" >> "$temp_file"
    
    echo "Validando funci√≥n en $file (l√≠neas $start_line-$end_line):"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    echo "Contenido del archivo original:"
    git show "$local_commit:$file" | sed -n "${start_line},${end_line}p" | nl -ba
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    
    # Ejecutar phpcs y procesar su salida
    if ! phpcs_output=$(vendor/bin/phpcs --standard=phpcs.xml "$temp_file" 2>&1); then
        # Procesar la salida para mostrar n√∫meros de l√≠nea correctos
        while IFS= read -r line; do
            if [[ $line =~ ^[[:space:]]*([0-9]+)[[:space:]]*\|[[:space:]]*(ERROR|WARNING) ]]; then
                # Ajustar el n√∫mero de l√≠nea al archivo original
                reported_line="${BASH_REMATCH[1]}"
                error_type="${BASH_REMATCH[2]}"
                actual_line=$((reported_line + original_line_offset))
                echo "L√≠nea $actual_line: $error_type - Falta o hay un problema con la documentaci√≥n de la funci√≥n"
            else
                echo "$line"
            fi
        done <<< "$phpcs_output"
        
        echo "‚ùå Error encontrado en la funci√≥n que comienza en la l√≠nea $start_line"
        return 1
    fi
    
    return 0
}

# Procesar cada archivo PHP modificado
has_errors=0

while IFS= read -r file; do
    [[ $file != *.php ]] && continue
    
    echo "üìÇ Analizando $file..."
    
    # Obtener el contenido actual del archivo
    content=$(git show "$local_commit:$file")
    
    # Procesar cada hunk modificado
    while IFS= read -r hunk; do
        [[ $hunk =~ ^@@ ]] || continue
        
        if [[ $hunk =~ \+([0-9]+)(,[0-9]+)? ]]; then
            modified_line="${BASH_REMATCH[1]}"
            
            # Obtener los l√≠mites de la funci√≥n
            read start_line end_line < <(get_function_bounds "$file" "$modified_line" "$content")
            
            if ! validate_function "$file" "$start_line" "$end_line"; then
                has_errors=1
                echo "‚ùå La funci√≥n en la l√≠nea $start_line necesita documentaci√≥n PHPDoc v√°lida"
                echo "   Debe incluir:"
                echo "   - Descripci√≥n de la funci√≥n"
                echo "   - @return con el tipo de retorno"
                echo "   - No debe tener l√≠neas vac√≠as innecesarias"
            fi
        fi
    done < <(git diff -U0 "$remote_commit" "$local_commit" -- "$file" | grep -E '^@@')
    
done < <(git diff --name-only "$remote_commit" "$local_commit")

# Verificaci√≥n final
if [ $has_errors -eq 1 ]; then
    exit_with_error "Se encontraron errores en la documentaci√≥n PHPDoc. Por favor, corrige los problemas antes de hacer push."
fi

echo "‚úÖ Validaci√≥n exitosa. Continuando con el push."
exit 0