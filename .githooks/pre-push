#!/bin/sh

echo "üöÄ Iniciando validaci√≥n de documentaci√≥n y c√≥digo PHP antes del push..."

# Detectar archivos modificados respecto a origin/main
MODIFIED_FILES=$(git diff --cached --name-only origin/main -- '*.php')

if [ -z "$MODIFIED_FILES" ]; then
    echo "‚úÖ No se detectaron archivos PHP modificados para validar."
    exit 0
fi

echo "üìÑ Archivos modificados detectados:"
echo "$MODIFIED_FILES"

# Ejecutar el script personalizado para documentar y validar PHPDoc
echo "üîç Ejecutando script de validaci√≥n y generaci√≥n autom√°tica de documentaci√≥n..."
php scripts/doc-fixer.php $MODIFIED_FILES
DOC_EXIT_CODE=$?

if [ $DOC_EXIT_CODE -ne 0 ]; then
    echo "‚ùå Error al ejecutar doc-fixer.php. Se detiene el push."
    exit 1
fi

# Validar con PHPCS solo los archivos modificados
echo "üß™ Ejecutando PHPCS en los archivos modificados..."

ERROR=0
for file in $MODIFIED_FILES; do
    echo "‚û°Ô∏è Validando $file"
    ./vendor/bin/phpcs "$file"
    if [ $? -ne 0 ]; then
        ERROR=1
    fi
done

if [ $ERROR -ne 0 ]; then
    echo "‚ùå Errores detectados por PHPCS. Corrige antes de hacer push."
    exit 1
fi

echo "‚úÖ Validaci√≥n completada sin errores. Procediendo con el push."
exit 0
